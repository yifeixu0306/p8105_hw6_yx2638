---
title: "Homework 6"
author: "Yifei Xu"
date: "2022-12-02"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(purrr)
library(modelr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

### Problem 2

First, import the dataset from the GitHub repository.

```{r, message=FALSE}
data_url = "https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv"

homicide = read_csv(url(data_url)) 
```

Second, clean the dataset as required.

```{r, message=FALSE}
homicide_tidy = homicide %>%
  janitor::clean_names() %>%
  mutate(state = toupper(state)) %>%
  mutate(city_state = str_c(city, state, sep = ", ")) %>%
  filter(!city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO")) %>%
  filter(victim_race %in% c("White", "Black")) %>%
  mutate(reported_date = as.Date(as.character(reported_date), format = "%Y%m%d"),
         city_state = str_c(city, state, sep = ", "), 
         resolved = as.numeric(disposition == "Closed by arrest"),
         victim_age = as.numeric(victim_age),
         victim_sex = fct_relevel(victim_sex, "Female")) %>% 
  select(city_state, everything()) 

```

Third, fit a logistic regression for the city of Baltimore, MD.

```{r}
# filter out the records in Baltimore, MD
baltimore_df = homicide_tidy %>%
  filter(city_state == "Baltimore, MD") 

# GLE
fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) 

# summary
fit_summary = fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         conf_low = exp(estimate - 1.96 * std.error),
         conf_high = exp(estimate + 1.96 * std.error)) %>%
  select(term, OR, conf_low, conf_high) 

fit_summary

# sex
fit_summary %>%
  filter(term == "victim_sexMale")%>%
  mutate(term = str_replace(term, "victim_sex", "Sex: ")) %>%
  knitr::kable(col.names = c("Term", "Adjusted Odds Ratio", "Lower CI", "Upper CI"),
               caption = "Odds Ratio and CIs for Solving Homicides in Baltimore Comparing Male to Female",
               digits = 3)
  
```

Homicides in which the victim is male are significantly less like to be resolved than those in which the victim is female.

Fourth, run glm for each of the cities.

```{r}
city_gle = 
  homicide_tidy %>% 
  nest(data = -city_state) %>% 
  mutate(models = map(.x = data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
         results = map(models, broom::tidy)) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(OR = exp(estimate),
         conf_low = exp(estimate - 1.96 * std.error),
         conf_high = exp(estimate + 1.96 * std.error)) %>% 
  select(city_state, term, OR, conf_low, conf_high) 

# sex
city_gle %>%
  filter(term == "victim_sexMale")%>%
  select(-term) %>%
  knitr::kable(col.names = c("City", "Adjusted Odds Ratio", "Lower CI", "Upper CI"),
               caption = "Odds Ratio and CIs for Solving Homicides Comparing Male to Female",
               digits = 3)

```

Finally, create a plot that shows the estimated ORs and CIs for each city.

```{r}
city_gle %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = conf_low, ymax = conf_high)) + 
  labs(x = "City", 
       y = "Adjusted Odds Ratio",
       title = "Estimated Odds Ratio and CIs for Solving Homicides Comparing Male to Female") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        plot.title = element_text(size = 12))
```

For `r city_gle %>% filter(term == "victim_sexMale") %>% filter(OR<1) %>% summarise(count=n()/47) %>% pull() %>% scales::percent(0.01)` of the cities, the estimate odds ratio for solving homicides for males comparing to females is less than one. In addition, for some of those cities (OR<1) such as New York and Baton Rouge, the odds ratio confidence interval does not include 1, which means the homicides in which the victim is male are significantly less likely to be resolved than those in which the victim is female. 

### Problem 3 

### Data Import

```{r, message=FALSE}
birthweight = read_csv("data/birthweight.csv")
```

### Data Preprocessing

```{r}
birthweight_tidy =
  birthweight %>% 
  janitor::clean_names() %>%
  mutate(across(.cols = c(babysex, frace, malform, mrace), as.factor)) %>%
  mutate(babysex = case_when(babysex == 1 ~"male", babysex == 2 ~"female"),
         malform = case_when(malform == 0 ~"absent", malform == 1 ~ "present"),
         frace = recode(frace, 
                        "1" = "White", 
                        "2" = "Black", 
                        "3" = "Asian", 
                        "4" = "Puerto Rican", 
                        "8" = "Other", 
                        "9" = "Unknown"),
         mrace = recode(mrace, 
                        "1" = "White", 
                        "2" = "Black", 
                        "3" = "Asian", 
                        "4" = "Puerto Rican", 
                        "8" = "Other"))

# check missing values
sum(is.na(birthweight_tidy))

```

### Propose a Regression Model for Birthweight.

First, I use stepwise method to select variables.

```{r}
mult_fit = lm(bwt ~ ., data=birthweight_tidy)
step(mult_fit, direction="both")
```

After stepwise selection, I get babysex, bhead, blength, delwt, fincome, gaweeks, mheight, mrace, parity, ppwt and smoken left in the model.

```{r}
mult_fit_1 = lm(bwt ~  babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken,
              data=birthweight_tidy)

summary(mult_fit_1)
```

Second, I would like to explore the interactions among these selected continuous variables.

```{r, message=FALSE, warning=FALSE}
fit_var = birthweight_tidy %>%
  select(bhead, blength, delwt, fincome, gaweeks, mheight, parity, ppwt, smoken)

PerformanceAnalytics::chart.Correlation(fit_var, method = "pearson")
```

From the plot above, we can observe that the a potential interaction might exsit between `delwt` and `ppwt` (r=0.87), as well as `bhead` and `blength` (r=0.64). Therefore, I plan to add these two interaction items in my model.

```{r}
mult_fit_2 = lm(bwt ~  babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken +
                  delwt*ppwt + bhead*blength,
              data=birthweight_tidy)

summary(mult_fit_2)
```

Next, I will show a plot of model residuals against fitted values.

```{r, message=FALSE}
birthweight_tidy %>%
  add_residuals(mult_fit_2) %>%
  add_predictions(mult_fit_2) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Plot of the Model Residuals Against Fitted Values",
       x = "Fitted Values", y = "Residuals") +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```


















